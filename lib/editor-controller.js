"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Atom = require("atom");
const rx = require("./regex");
const selectors = [
    'identifier.haskell',
    'entity.name.type.haskell',
    'entity.name.tag.haskell',
];
const operatorSelectors = [
    'keyword.operator.haskell',
    'entity.name.function.infix.haskell',
];
const activationScopes = ['source.haskell', 'text.tex.latex.haskell'];
const knownIdentClass = 'syntax--known-identifier';
class EditorController {
    constructor(editor, cb) {
        this.editor = editor;
        this.cb = cb;
        this.disposed = false;
        this.disposables = new Atom.CompositeDisposable();
        this.layer = this.editor.addMarkerLayer();
        this.disposables.add(this.editor.getBuffer().onDidChangeText((arg) => {
            handlePromise(this.didChangeText(arg));
        }));
        this.disposables.add(editor.onDidDestroy(() => {
            this.dispose();
        }));
        this.init();
    }
    static shouldActivate(ed) {
        return activationScopes.includes(ed.getGrammar().scopeName);
    }
    dispose() {
        if (!this.disposed) {
            this.disposed = true;
            this.layer.destroy();
            this.disposables.dispose();
        }
    }
    async init() {
        this.updateHighlightInRange(await this.getSymbols(), this.editor.getBuffer().getRange());
    }
    async didChangeText({ changes }) {
        const buffer = this.editor.getBuffer();
        const sbs = await this.getSymbols();
        for (const { newRange, oldRange } of changes) {
            for (const row of newRange.union(oldRange).getRows()) {
                this.updateHighlightInRange(sbs, buffer.rangeForRow(row));
            }
        }
    }
    updateHighlightInRange(sbs, searchRange) {
        for (const marker of this.layer.findMarkers({
            intersectsBufferRange: searchRange,
        })) {
            marker.destroy();
        }
        const buffer = this.editor.getBuffer();
        const range = Atom.Range.fromObject(searchRange);
        const decorate = (idents, selectors) => {
            for (const ident of idents) {
                if (sbs.has(buffer.getTextInRange(ident))) {
                    this.decorateRange(ident, selectors);
                }
            }
        };
        handlePromise(buffer
            .findAllInRange(rx.identRx, range)
            .then((idents) => decorate(idents, selectors)));
        handlePromise(buffer
            .findAllInRange(rx.operatorRx, range)
            .then((ops) => decorate(ops, operatorSelectors)));
    }
    async getSymbols() {
        const symbols = await this.cb.getCompletionsForSymbol(this.editor.getBuffer(), '', Atom.Point.fromObject([0, 0]));
        return new Set(symbols.map(({ qname }) => qname));
    }
    decorateRange(range, myselectors) {
        const [inScope] = this.editor
            .scopeDescriptorForBufferPosition(range.start)
            .getScopesArray()
            .filter((sel) => myselectors.includes(sel));
        if (inScope) {
            const srange = this.editor.bufferRangeForScopeAtPosition(inScope, range.start);
            const marker = this.layer.markBufferRange(srange || range, {
                invalidate: 'never',
            });
            this.editor.decorateMarker(marker, {
                type: 'text',
                class: knownIdentClass,
            });
        }
    }
}
exports.EditorController = EditorController;
function handlePromise(p) {
    p.catch(function (e) {
        atom.notifications.addError(`Something went wrong in language-haskell-scoped: ${e.name}`, {
            detail: e.message,
            stack: e.stack,
            dismissable: true,
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZWRpdG9yLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNEI7QUFDNUIsOEJBQTZCO0FBRzdCLE1BQU0sU0FBUyxHQUFHO0lBQ2hCLG9CQUFvQjtJQUNwQiwwQkFBMEI7SUFDMUIseUJBQXlCO0NBQzFCLENBQUE7QUFFRCxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLDBCQUEwQjtJQUMxQixvQ0FBb0M7Q0FDckMsQ0FBQTtBQUVELE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFBO0FBRXJFLE1BQU0sZUFBZSxHQUFHLDBCQUEwQixDQUFBO0FBRWxEO0lBS0UsWUFBb0IsTUFBdUIsRUFBVSxFQUFzQjtRQUF2RCxXQUFNLEdBQU4sTUFBTSxDQUFpQjtRQUFVLE9BQUUsR0FBRixFQUFFLENBQW9CO1FBSm5FLGFBQVEsR0FBRyxLQUFLLENBQUE7UUFFaEIsZ0JBQVcsR0FBRyxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO1FBR2xELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUN6QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUM5QyxhQUFhLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3hDLENBQUMsQ0FBQyxDQUNILENBQUE7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDdkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUE7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RDtZQUNFLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTztZQUNqQixLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUs7WUFDZCxXQUFXLEVBQUUsSUFBSTtTQUNsQixDQUNGLENBQUE7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBdG9tIGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyByeCBmcm9tICcuL3JlZ2V4J1xuaW1wb3J0IHsgSUNvbXBsZXRpb25CYWNrZW5kIH0gZnJvbSAnYXRvbS1oYXNrZWxsLXVwaS9jb21wbGV0aW9uLWJhY2tlbmQnXG5cbmNvbnN0IHNlbGVjdG9ycyA9IFtcbiAgJ2lkZW50aWZpZXIuaGFza2VsbCcsXG4gICdlbnRpdHkubmFtZS50eXBlLmhhc2tlbGwnLFxuICAnZW50aXR5Lm5hbWUudGFnLmhhc2tlbGwnLFxuXVxuXG5jb25zdCBvcGVyYXRvclNlbGVjdG9ycyA9IFtcbiAgJ2tleXdvcmQub3BlcmF0b3IuaGFza2VsbCcsXG4gICdlbnRpdHkubmFtZS5mdW5jdGlvbi5pbmZpeC5oYXNrZWxsJyxcbl1cblxuY29uc3QgYWN0aXZhdGlvblNjb3BlcyA9IFsnc291cmNlLmhhc2tlbGwnLCAndGV4dC50ZXgubGF0ZXguaGFza2VsbCddXG5cbmNvbnN0IGtub3duSWRlbnRDbGFzcyA9ICdzeW50YXgtLWtub3duLWlkZW50aWZpZXInXG5cbmV4cG9ydCBjbGFzcyBFZGl0b3JDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSBkaXNwb3NlZCA9IGZhbHNlXG4gIHByaXZhdGUgbGF5ZXI6IEF0b20uRGlzcGxheU1hcmtlckxheWVyXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQXRvbS5Db21wb3NpdGVEaXNwb3NhYmxlKClcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogQXRvbS5UZXh0RWRpdG9yLCBwcml2YXRlIGNiOiBJQ29tcGxldGlvbkJhY2tlbmQpIHtcbiAgICB0aGlzLmxheWVyID0gdGhpcy5lZGl0b3IuYWRkTWFya2VyTGF5ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRDaGFuZ2VUZXh0KChhcmcpID0+IHtcbiAgICAgICAgaGFuZGxlUHJvbWlzZSh0aGlzLmRpZENoYW5nZVRleHQoYXJnKSlcbiAgICAgIH0pLFxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgfSksXG4gICAgKVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMuaW5pdCgpXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHNob3VsZEFjdGl2YXRlKGVkOiBBdG9tLlRleHRFZGl0b3IpOiBib29sZWFuIHtcbiAgICByZXR1cm4gYWN0aXZhdGlvblNjb3Blcy5pbmNsdWRlcyhlZC5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lKVxuICB9XG5cbiAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgaWYgKCF0aGlzLmRpc3Bvc2VkKSB7XG4gICAgICB0aGlzLmRpc3Bvc2VkID0gdHJ1ZVxuICAgICAgdGhpcy5sYXllci5kZXN0cm95KClcbiAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0KCkge1xuICAgIHRoaXMudXBkYXRlSGlnaGxpZ2h0SW5SYW5nZShcbiAgICAgIGF3YWl0IHRoaXMuZ2V0U3ltYm9scygpLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0UmFuZ2UoKSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRpZENoYW5nZVRleHQoeyBjaGFuZ2VzIH06IEF0b20uQnVmZmVyU3RvcHBlZENoYW5naW5nRXZlbnQpIHtcbiAgICBjb25zdCBidWZmZXIgPSB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKVxuICAgIGNvbnN0IHNicyA9IGF3YWl0IHRoaXMuZ2V0U3ltYm9scygpXG4gICAgZm9yIChjb25zdCB7IG5ld1JhbmdlLCBvbGRSYW5nZSB9IG9mIGNoYW5nZXMpIHtcbiAgICAgIGZvciAoY29uc3Qgcm93IG9mIG5ld1JhbmdlLnVuaW9uKG9sZFJhbmdlKS5nZXRSb3dzKCkpIHtcbiAgICAgICAgdGhpcy51cGRhdGVIaWdobGlnaHRJblJhbmdlKHNicywgYnVmZmVyLnJhbmdlRm9yUm93KHJvdykpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVIaWdobGlnaHRJblJhbmdlKFxuICAgIHNiczogU2V0PHN0cmluZz4sXG4gICAgc2VhcmNoUmFuZ2U6IEF0b20uUmFuZ2VDb21wYXRpYmxlLFxuICApIHtcbiAgICBmb3IgKGNvbnN0IG1hcmtlciBvZiB0aGlzLmxheWVyLmZpbmRNYXJrZXJzKHtcbiAgICAgIGludGVyc2VjdHNCdWZmZXJSYW5nZTogc2VhcmNoUmFuZ2UsXG4gICAgfSkpIHtcbiAgICAgIG1hcmtlci5kZXN0cm95KClcbiAgICB9XG4gICAgY29uc3QgYnVmZmVyID0gdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKClcbiAgICBjb25zdCByYW5nZSA9IEF0b20uUmFuZ2UuZnJvbU9iamVjdChzZWFyY2hSYW5nZSlcblxuICAgIGNvbnN0IGRlY29yYXRlID0gKGlkZW50czogQXRvbS5SYW5nZUxpa2VbXSwgc2VsZWN0b3JzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgZm9yIChjb25zdCBpZGVudCBvZiBpZGVudHMpIHtcbiAgICAgICAgaWYgKHNicy5oYXMoYnVmZmVyLmdldFRleHRJblJhbmdlKGlkZW50KSkpIHtcbiAgICAgICAgICB0aGlzLmRlY29yYXRlUmFuZ2UoaWRlbnQsIHNlbGVjdG9ycylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGhhbmRsZVByb21pc2UoXG4gICAgICBidWZmZXJcbiAgICAgICAgLmZpbmRBbGxJblJhbmdlKHJ4LmlkZW50UngsIHJhbmdlKVxuICAgICAgICAudGhlbigoaWRlbnRzKSA9PiBkZWNvcmF0ZShpZGVudHMsIHNlbGVjdG9ycykpLFxuICAgIClcblxuICAgIGhhbmRsZVByb21pc2UoXG4gICAgICBidWZmZXJcbiAgICAgICAgLmZpbmRBbGxJblJhbmdlKHJ4Lm9wZXJhdG9yUngsIHJhbmdlKVxuICAgICAgICAudGhlbigob3BzKSA9PiBkZWNvcmF0ZShvcHMsIG9wZXJhdG9yU2VsZWN0b3JzKSksXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRTeW1ib2xzKCkge1xuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmNiLmdldENvbXBsZXRpb25zRm9yU3ltYm9sKFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCksXG4gICAgICAnJyxcbiAgICAgIEF0b20uUG9pbnQuZnJvbU9iamVjdChbMCwgMF0pLFxuICAgIClcbiAgICByZXR1cm4gbmV3IFNldChzeW1ib2xzLm1hcCgoeyBxbmFtZSB9KSA9PiBxbmFtZSkpXG4gIH1cblxuICBwcml2YXRlIGRlY29yYXRlUmFuZ2UocmFuZ2U6IEF0b20uUmFuZ2VMaWtlLCBteXNlbGVjdG9yczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBbaW5TY29wZV0gPSB0aGlzLmVkaXRvclxuICAgICAgLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHJhbmdlLnN0YXJ0KVxuICAgICAgLmdldFNjb3Blc0FycmF5KClcbiAgICAgIC5maWx0ZXIoKHNlbCkgPT4gbXlzZWxlY3RvcnMuaW5jbHVkZXMoc2VsKSlcbiAgICBpZiAoaW5TY29wZSkge1xuICAgICAgY29uc3Qgc3JhbmdlID0gdGhpcy5lZGl0b3IuYnVmZmVyUmFuZ2VGb3JTY29wZUF0UG9zaXRpb24oXG4gICAgICAgIGluU2NvcGUsXG4gICAgICAgIHJhbmdlLnN0YXJ0LFxuICAgICAgKVxuICAgICAgY29uc3QgbWFya2VyID0gdGhpcy5sYXllci5tYXJrQnVmZmVyUmFuZ2Uoc3JhbmdlIHx8IHJhbmdlLCB7XG4gICAgICAgIGludmFsaWRhdGU6ICduZXZlcicsXG4gICAgICB9KVxuICAgICAgLy8gQHRzLWlnbm9yZSAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgICAgdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgIHR5cGU6ICd0ZXh0JyxcbiAgICAgICAgY2xhc3M6IGtub3duSWRlbnRDbGFzcyxcbiAgICAgIH0pXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVByb21pc2UocDogUHJvbWlzZTx2b2lkPik6IHZvaWQge1xuICBwLmNhdGNoKGZ1bmN0aW9uKGU6IEVycm9yKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgYFNvbWV0aGluZyB3ZW50IHdyb25nIGluIGxhbmd1YWdlLWhhc2tlbGwtc2NvcGVkOiAke2UubmFtZX1gLFxuICAgICAge1xuICAgICAgICBkZXRhaWw6IGUubWVzc2FnZSxcbiAgICAgICAgc3RhY2s6IGUuc3RhY2ssXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgfSxcbiAgICApXG4gIH0pXG59XG4iXX0=
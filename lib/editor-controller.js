"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Atom = require("atom");
const rx = require("./regex");
const selectors = [
    'identifier.haskell',
    'entity.name.type.haskell',
    'entity.name.tag.haskell',
];
const operatorSelectors = [
    'keyword.operator.haskell',
    'entity.name.function.infix.haskell',
];
const activationScopes = ['source.haskell', 'text.tex.latex.haskell'];
const knownIdentClass = 'syntax--known-identifier';
class EditorController {
    constructor(editor, cb) {
        this.editor = editor;
        this.cb = cb;
        this.disposed = false;
        this.disposables = new Atom.CompositeDisposable();
        this.layer = this.editor.addMarkerLayer();
        this.disposables.add(this.editor.getBuffer().onDidChangeText(async ({ changes }) => {
            const sbs = await this.getSymbols();
            for (const { newRange } of changes) {
                await this.updateHighlightInRange(sbs, [
                    [newRange.start.row, 0],
                    [newRange.end.row + 1, 0],
                ]);
            }
        }));
        this.disposables.add(editor.onDidDestroy(() => {
            this.dispose();
        }));
        this.init();
    }
    static shouldActivate(ed) {
        return activationScopes.includes(ed.getGrammar().scopeName);
    }
    dispose() {
        if (!this.disposed) {
            this.disposed = true;
            this.layer.destroy();
            this.disposables.dispose();
        }
    }
    async init() {
        await this.updateHighlightInRange(await this.getSymbols(), this.editor.getBuffer().getRange());
    }
    async updateHighlightInRange(sbs, searchRange) {
        for (const marker of this.layer.findMarkers({
            intersectsBufferRange: searchRange,
        })) {
            marker.destroy();
        }
        this.editor.scanInBufferRange(rx.identRx, searchRange, async ({ matchText, range }) => {
            if (sbs.has(matchText)) {
                await this.decorateRange(range, selectors);
            }
        });
        this.editor.scanInBufferRange(rx.operatorRx, searchRange, async ({ matchText, range }) => {
            if (sbs.has(matchText)) {
                await this.decorateRange(range, operatorSelectors);
            }
        });
    }
    async getSymbols() {
        const symbols = await this.cb.getCompletionsForSymbol(this.editor.getBuffer(), '', Atom.Point.fromObject([0, 0]));
        return new Set(symbols.map(({ qname }) => qname));
    }
    async decorateRange(range, myselectors) {
        const [inScope] = this.editor
            .scopeDescriptorForBufferPosition(range.start)
            .getScopesArray()
            .filter((sel) => myselectors.includes(sel));
        if (inScope) {
            const srange = this.editor.bufferRangeForScopeAtPosition(inScope, range.start);
            const marker = this.layer.markBufferRange(srange || range, {
                invalidate: 'never',
            });
            this.editor.decorateMarker(marker, {
                type: 'text',
                class: knownIdentClass,
            });
        }
    }
}
exports.EditorController = EditorController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZWRpdG9yLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNEI7QUFDNUIsOEJBQTZCO0FBRzdCLE1BQU0sU0FBUyxHQUFHO0lBQ2hCLG9CQUFvQjtJQUNwQiwwQkFBMEI7SUFDMUIseUJBQXlCO0NBQzFCLENBQUE7QUFFRCxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLDBCQUEwQjtJQUMxQixvQ0FBb0M7Q0FDckMsQ0FBQTtBQUVELE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSx3QkFBd0IsQ0FBQyxDQUFBO0FBRXJFLE1BQU0sZUFBZSxHQUFHLDBCQUEwQixDQUFBO0FBRWxEO0lBS0UsWUFBb0IsTUFBdUIsRUFBVSxFQUFzQjtRQUF2RCxXQUFNLEdBQU4sTUFBTSxDQUFpQjtRQUFVLE9BQUUsR0FBRixFQUFFLENBQW9CO1FBSm5FLGFBQVEsR0FBRyxLQUFLLENBQUE7UUFFaEIsZ0JBQVcsR0FBRyxJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO1FBR2xELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUN6QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRTtZQUM1RCxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtZQUNuQyxLQUFLLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxPQUFPLEVBQUU7Z0JBQ2xDLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRTtvQkFDckMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENB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LENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzthQUM3QyxjQUFjLEVBQUU7YUFDaEIsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDN0MsSUFBSSxPQUFPLEVBQUU7WUFDWCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUN0RCxPQUFPLEVBQ1AsS0FBSyxDQUFDLEtBQUssQ0FDWixDQUFBO1lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBTSxJQUFJLEtBQUssRUFBRTtnQkFDekQsVUFBVSxFQUFFLE9BQU87YUFDcEIsQ0FBQyxDQUFBO1lBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFO2dCQUNqQyxJQUFJLEVBQUUsTUFBTTtnQkFDWixLQUFLLEVBQUUsZUFBZTthQUN2QixDQUFDLENBQUE7U0FDSDtJQUNILENBQUM7Q0FDRjtBQXhHRCw0Q0F3R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBdG9tIGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyByeCBmcm9tICcuL3JlZ2V4J1xuaW1wb3J0IHsgSUNvbXBsZXRpb25CYWNrZW5kIH0gZnJvbSAnYXRvbS1oYXNrZWxsLXVwaS9jb21wbGV0aW9uLWJhY2tlbmQnXG5cbmNvbnN0IHNlbGVjdG9ycyA9IFtcbiAgJ2lkZW50aWZpZXIuaGFza2VsbCcsXG4gICdlbnRpdHkubmFtZS50eXBlLmhhc2tlbGwnLFxuICAnZW50aXR5Lm5hbWUudGFnLmhhc2tlbGwnLFxuXVxuXG5jb25zdCBvcGVyYXRvclNlbGVjdG9ycyA9IFtcbiAgJ2tleXdvcmQub3BlcmF0b3IuaGFza2VsbCcsXG4gICdlbnRpdHkubmFtZS5mdW5jdGlvbi5pbmZpeC5oYXNrZWxsJyxcbl1cblxuY29uc3QgYWN0aXZhdGlvblNjb3BlcyA9IFsnc291cmNlLmhhc2tlbGwnLCAndGV4dC50ZXgubGF0ZXguaGFza2VsbCddXG5cbmNvbnN0IGtub3duSWRlbnRDbGFzcyA9ICdzeW50YXgtLWtub3duLWlkZW50aWZpZXInXG5cbmV4cG9ydCBjbGFzcyBFZGl0b3JDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSBkaXNwb3NlZCA9IGZhbHNlXG4gIHByaXZhdGUgbGF5ZXI6IEF0b20uRGlzcGxheU1hcmtlckxheWVyXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQXRvbS5Db21wb3NpdGVEaXNwb3NhYmxlKClcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogQXRvbS5UZXh0RWRpdG9yLCBwcml2YXRlIGNiOiBJQ29tcGxldGlvbkJhY2tlbmQpIHtcbiAgICB0aGlzLmxheWVyID0gdGhpcy5lZGl0b3IuYWRkTWFya2VyTGF5ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRDaGFuZ2VUZXh0KGFzeW5jICh7IGNoYW5nZXMgfSkgPT4ge1xuICAgICAgICBjb25zdCBzYnMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHMoKVxuICAgICAgICBmb3IgKGNvbnN0IHsgbmV3UmFuZ2UgfSBvZiBjaGFuZ2VzKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVIaWdobGlnaHRJblJhbmdlKHNicywgW1xuICAgICAgICAgICAgW25ld1JhbmdlLnN0YXJ0LnJvdywgMF0sXG4gICAgICAgICAgICBbbmV3UmFuZ2UuZW5kLnJvdyArIDEsIDBdLFxuICAgICAgICAgIF0pXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgfSksXG4gICAgKVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMuaW5pdCgpXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHNob3VsZEFjdGl2YXRlKGVkOiBBdG9tLlRleHRFZGl0b3IpOiBib29sZWFuIHtcbiAgICByZXR1cm4gYWN0aXZhdGlvblNjb3Blcy5pbmNsdWRlcyhlZC5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lKVxuICB9XG5cbiAgcHVibGljIGRpc3Bvc2UoKSB7XG4gICAgaWYgKCF0aGlzLmRpc3Bvc2VkKSB7XG4gICAgICB0aGlzLmRpc3Bvc2VkID0gdHJ1ZVxuICAgICAgdGhpcy5sYXllci5kZXN0cm95KClcbiAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0KCkge1xuICAgIGF3YWl0IHRoaXMudXBkYXRlSGlnaGxpZ2h0SW5SYW5nZShcbiAgICAgIGF3YWl0IHRoaXMuZ2V0U3ltYm9scygpLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0UmFuZ2UoKSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZUhpZ2hsaWdodEluUmFuZ2UoXG4gICAgc2JzOiBTZXQ8c3RyaW5nPixcbiAgICBzZWFyY2hSYW5nZTogQXRvbS5SYW5nZUNvbXBhdGlibGUsXG4gICkge1xuICAgIGZvciAoY29uc3QgbWFya2VyIG9mIHRoaXMubGF5ZXIuZmluZE1hcmtlcnMoe1xuICAgICAgaW50ZXJzZWN0c0J1ZmZlclJhbmdlOiBzZWFyY2hSYW5nZSxcbiAgICB9KSkge1xuICAgICAgbWFya2VyLmRlc3Ryb3koKVxuICAgIH1cbiAgICB0aGlzLmVkaXRvci5zY2FuSW5CdWZmZXJSYW5nZShcbiAgICAgIHJ4LmlkZW50UngsXG4gICAgICBzZWFyY2hSYW5nZSxcbiAgICAgIGFzeW5jICh7IG1hdGNoVGV4dCwgcmFuZ2UgfSkgPT4ge1xuICAgICAgICBpZiAoc2JzLmhhcyhtYXRjaFRleHQpKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5kZWNvcmF0ZVJhbmdlKHJhbmdlLCBzZWxlY3RvcnMpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIHRoaXMuZWRpdG9yLnNjYW5JbkJ1ZmZlclJhbmdlKFxuICAgICAgcngub3BlcmF0b3JSeCxcbiAgICAgIHNlYXJjaFJhbmdlLFxuICAgICAgYXN5bmMgKHsgbWF0Y2hUZXh0LCByYW5nZSB9KSA9PiB7XG4gICAgICAgIGlmIChzYnMuaGFzKG1hdGNoVGV4dCkpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmRlY29yYXRlUmFuZ2UocmFuZ2UsIG9wZXJhdG9yU2VsZWN0b3JzKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0U3ltYm9scygpIHtcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5jYi5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbChcbiAgICAgIHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLFxuICAgICAgJycsXG4gICAgICBBdG9tLlBvaW50LmZyb21PYmplY3QoWzAsIDBdKSxcbiAgICApXG4gICAgcmV0dXJuIG5ldyBTZXQoc3ltYm9scy5tYXAoKHsgcW5hbWUgfSkgPT4gcW5hbWUpKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkZWNvcmF0ZVJhbmdlKHJhbmdlOiBBdG9tLlJhbmdlLCBteXNlbGVjdG9yczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBbaW5TY29wZV0gPSB0aGlzLmVkaXRvclxuICAgICAgLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHJhbmdlLnN0YXJ0KVxuICAgICAgLmdldFNjb3Blc0FycmF5KClcbiAgICAgIC5maWx0ZXIoKHNlbCkgPT4gbXlzZWxlY3RvcnMuaW5jbHVkZXMoc2VsKSlcbiAgICBpZiAoaW5TY29wZSkge1xuICAgICAgY29uc3Qgc3JhbmdlID0gdGhpcy5lZGl0b3IuYnVmZmVyUmFuZ2VGb3JTY29wZUF0UG9zaXRpb24oXG4gICAgICAgIGluU2NvcGUsXG4gICAgICAgIHJhbmdlLnN0YXJ0LFxuICAgICAgKVxuICAgICAgY29uc3QgbWFya2VyID0gdGhpcy5sYXllci5tYXJrQnVmZmVyUmFuZ2Uoc3JhbmdlIHx8IHJhbmdlLCB7XG4gICAgICAgIGludmFsaWRhdGU6ICduZXZlcicsXG4gICAgICB9KVxuICAgICAgLy8gQHRzLWlnbm9yZSAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgICAgdGhpcy5lZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG4gICAgICAgIHR5cGU6ICd0ZXh0JyxcbiAgICAgICAgY2xhc3M6IGtub3duSWRlbnRDbGFzcyxcbiAgICAgIH0pXG4gICAgfVxuICB9XG59XG4iXX0=